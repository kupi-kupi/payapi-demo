# 

**ИНСТРУКЦИЯ ПО РАБОТЕ С API КЕШБЭК-СЕРВИСА «КУПИ_КУПИ»**

## **Процесс работы** API-сервиса

**Процесс работы API-сервиса следующий, на странице оплаты товара:**

1. Проверка баланса пользователя (не обязательно): Перед тем как отобразить кнопку кешбэк-сервисе «Оплатить баллами Купи-Купи» нужно выполнить запрос на проверку баланса пользователя. Предполагается, что пользователь авторизован в вашей системе или у вас есть доступ к его номеру телефона – выполняется запрос метод Balance. В результате выполнения запроса возвращается информацию о доступном балансе баллов пользователя. На стороне своего сайта/сервиса вы можете сравнить сумму заказа с количеством баллов и не показывать кнопку, если количество баллов меньше суммы заказа;
2. Передача данных в форму списания баллов кешбэк-сервиса: Когда пользователь на вашем сайте/сервисе выбрал способ оплаты «Оплатить баллами Купи-Купи», то в этом случае сайт/сервис формирует запрос на метод API-сервиса с указанным набором данных, после проверки всех данных кешбэк-сервис (в случае успеха) возвращается ссылка на сгенерированную форму для перевода баллов. Далее сайт/сервис перенаправляет пользователя по этой ссылке на форму, где пользователь вводит специальный код для перевода, который ему присылает кешбэк-сервисе «Купи-Купи» в его личном кабинете. После перевода баллов  кешбэк-сервис отправляет информацию о переводе на сайт/сервис на указанный при регистрации NotificationURL где ваш сайт/сервис производит регистрацию перевода в своей системе.
3. Для окончательного подтверждения проведения перевода баллов от покупателя продавцу считается выполненный запрос с значением статуса «CONFIRMED».
4. Для принудительного получения статуса транзакции можно воспользоваться методом checkOut.

## **Методы API-сервиса**

### **Общая информация**

1. Все запросы осуществляются на единый URL-адрес с указание наименования метода;
2. Все данные передаются и возвращаются методом POST в JSON-формате;
3. При использовании методов предложенного PHP-класса, передавать параметры UidPlatform и Token не нужно.

### Примеры кода запросов методов

Подключение класса:

```
require_once('KupiKupiPayApi.php');

$api = new KupiKupiPayApi(
    'M2hULcD5OiYGkmSK',  // UID платформы
    'yIKirCvplm0N1DOg'   // Ваш Secret_Key
);
```

Метод получения баланса пользоватея:

```
$api->balance(79000000001);
```

Метод отправки запроса на перевод баллов:

```
$api->init(
        [
            'phone'   => 79000000000, // Телефон пользователя
            'orderId' => rand(1000, 9999), // ID-заказа на Вашем сайте
            'amount'  => rand(100, 10000) // Сумма заказа в копейках
        ]
    );
```

Метод возвращает статус заказа в кешбэк-сервисе «Купи-Купи»:

```
$api->checkout(
        [
            'orderId' => 9921, // ID-заказа на Вашем сайте
            'amount'  => 972 // Сумма заказа в копейках
        ]
    )
```
