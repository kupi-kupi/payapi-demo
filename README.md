![logo.svg](assets/logo.svg)

# **ИНСТРУКЦИЯ ПО РАБОТЕ С API КЕШБЭК-СЕРВИСА «КУПИ_КУПИ»**

## **Процесс работы** API-сервиса

**Процесс работы API-сервиса следующий, на странице оплаты товара:**

1. Проверка баланса пользователя (необязательно): Перед тем как отобразить кнопку кешбэк-сервисе «Оплатить баллами Купи-Купи» нужно выполнить запрос на проверку баланса пользователя. Предполагается, что пользователь авторизован в вашей системе или у вас есть доступ к его номеру телефона – выполняется запрос метод Balance. В результате выполнения запроса возвращается информацию о доступном балансе баллов пользователя. На стороне своего сайта/сервиса вы можете сравнить сумму заказа с количеством баллов и не показывать кнопку, если количество баллов меньше суммы заказа;
2. Передача данных в форму списания баллов кешбэк-сервиса: Когда пользователь на вашем сайте/сервисе выбрал способ оплаты «Оплатить баллами Купи-Купи», то в этом случае сайт/сервис формирует запрос на метод API-сервиса с указанным набором данных, после проверки всех данных кешбэк-сервис (в случае успеха) возвращается ссылка на сгенерированную форму для перевода баллов. Далее сайт/сервис перенаправляет пользователя по этой ссылке на форму, где пользователь вводит специальный код для перевода, который ему присылает кешбэк-сервисе «Купи-Купи» в его личном кабинете. После перевода баллов  кешбэк-сервис отправляет информацию о переводе на сайт/сервис на указанный при регистрации NotificationURL, где ваш сайт/сервис производит регистрацию перевода в своей системе.
3. Для окончательного подтверждения проведения перевода баллов от покупателя продавцу считается выполненный запрос со значением статуса «CONFIRMED».
4. Для принудительного получения статуса транзакции можно воспользоваться методом checkOut.

## **Регистрация в API-сервисе**


Для работы c функционалом API-сервиса необходимо иметь зарегистрированную и активную учетную запись в кешбэк-сервисе «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» с правами ТСП.

Для регистрации Вашего сайта в API-сервисе необходимо подать заявку в разделе «поддержка» в кешбэк-сервисе «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» указав следующую информацию, как для «боевой» (production), так и для тестовой версии сайтов:

* ***Адрес сайта***: (на сайте должен быть установлен и настроен SSL-сертификат);
* **SuccessURL:** ссылка на страницу успеха (длина не более 512 символов);
* **FailURL**: ссылка на страницу ошибки (длина не более 512 символов);
* **NotificationURL:** URL-путь до обработчика статуса ответа API-сервиса «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")», данный URL должен поддерживать обработку POST– запросов (длина не более 512 символов);

После успешной проверки предоставленных данных, Вам будут созданы и предоставлены:

* **SecretKey** секретный ключ «боевой» (production) версии сайта;
* **DevSecretKey** секретный ключ тестовой версии сайта;
* **UidPlatform** uid-платформы.

Эти данные необходимо будет указать в настройках при подключении API-сервису «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")». В случае, если используется тестовое подключение, то необходимо указать **DevSecretKey**, а **UidPlatform** будет одинаковым для обоих версий.

## **Методы API-сервиса**

### **Общая информация**

1. Все запросы осуществляются на единый URL-адрес с указанием наименования метода. ВАЖНО, перед началом работ указать среду отправки запросов (параметр $env);
2. Все данные передаются и возвращаются методом POST в JSON-формате;
3. При использовании методов предложенного PHP-класса, передавать параметры UidPlatform и Token не нужно.

### Примеры кода запросов методов

**Подключение класса:**

```
require_once('KupiKupiPayApi.php');

$api = new KupiKupiPayApi(
    'M2hULcD58iYGkmS7',  // UID платформы
    'yIKirCvplm8N1D9g'   // Ваш Secret_Key
);
```

---



### **Balance :: метод получения баланса пользователя:**

```
$api->balance(79000000001);
```

#### **Запрос:**


| **Наименование** | **Описание**                                                                                                                           | **Тип** | **Обязательный** |
| ---------------------------- |----------------------------------------------------------------------------------------------------------------------------------------| ---------- | ---------------------------- |
| uidPlatform                  | Идентификаторплатформы. Выдается продавцукешбэк-сервисом «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» при регистрации | String(20) | да                         |
| phone                        | Номер телефона клиента в формате: 79999999999                                                                                          | number     | да                         |
| token                        | См. [Подпись запроса](#_Token_::_п "Подпись запроса")                                                                                                                    | string     | да                         |

#### **Ответ:**


| **Наименование** | **Описание**                                                                      | **Тип**    | **Обязательный** |
| ---------------------------- | ----------------------------------------------------------------------------------------- | ------------- | ---------------------------- |
| status                       | Успешность операции: true - успешнаяfalse - неуспешная | boolean       | да                         |
| errorCode                    | Код ошибки: «0» - если успешно                                      | String(20)    | да                         |
| message                      | Краткое описание ошибки                                              | String        | нет                       |
| balance                      | Баланс пользователя                                                     | decimal(10,2) | да                         |



---



### **Init :: метод отправки запроса на перевод баллов:**

```
$api->init(
        [
            'phone'   => 79000000000, // Телефон пользователя
            'orderId' => 1234, // ID-заказа на Вашем сайте
            'amount'  => 25000 // Сумма заказа в копейках
        ]
    );
```

#### **Запрос:**

| **Наименование** | **Описание**                                                                                                                           | **Тип** | **Обязательный** |
| ---------------------------- |----------------------------------------------------------------------------------------------------------------------------------------| ---------- | ---------------------------- |
| uidPlatform                  | Идентификаторплатформы. Выдается продавцукешбэк-сервисом «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» при регистрации | String(20) | да                         |
| phone                        | Номер телефона клиента в формате: 79999999999                                                                                          | Number(11) | да                         |
| orderId                      | Номер заказа в системе Продавца                                                                                                        | String(36) | да                         |
| amount                       | Сумма операции в копейках                                                                                                              | Number(10) | да                         |
| token                        | См. [Подпись запроса](#_Token_::_п "Подпись запроса")                                                                                                                    | string     | да                         |

#### **Ответ:**

| **Наименование** | **Описание**                                                                                                                                           | **Тип**  | **Обязательный** |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ---------------------------- |
| status                       | Успешность операции: true - успешная false - неуспешная                                                                     | boolean     | да                         |
| errorCode                    | Код ошибки: «0» - если успешно                                                                                                           | String(20)  | да                         |
| message                      | Краткое описание ошибки                                                                                                                   | String      | нет                       |
| paymentId                    | Идентификаторпереводав системекешбэк-сервиса «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» | Number (20) | да                         |
| orderId                      | Номер заказа в системе Продавца                                                                                                     | String(36)  | да                         |
| amount                       | Сумма операции в копейках                                                                                                                | Number(10)  | да                         |
| transferURL                  | Ссылка на форму перевода баллов                                                                                                     | String(512) | да                         |

---



### **Checkout :: Метод возвращает статус заказа в кешбэк-сервисе «Купи-Купи»:**

```
$api->checkout(
        [
            'orderId' => 9921, // ID-заказа на Вашем сайте
            'amount'  => 972 // Сумма заказа в копейках
        ]
    );
```

#### **Запрос:**

| **Наименование** | **Описание**                                                                                                                            | **Тип** | **Обязательный** |
| ---------------------------- |-----------------------------------------------------------------------------------------------------------------------------------------| ---------- | ---------------------------- |
| uidPlatform                  | Идентификаторплатформы. Выдается продавцукешбэк-сервисом «[Купи-Купи](https://kupi-kupi.com/ "https://kupi-kupi.com/")» при регистрации | String(20) | да                         |
| orderId                      | Номер заказа в системе Продавца                                                                                                         | String(36) | да                         |
| amount                       | Сумма операции в копейках                                                                                                               | Number(10) | да                         |
| token                        | См. [Подпись запроса](#_Token_::_п "Подпись запроса")                                                                                   | string     | да                         |

#### **Ответ:**

| **Наименование** | **Описание**                                                                                               | **Тип**  | **Обязательный** |
| ---------------------------- |------------------------------------------------------------------------------------------------------------| ----------- | ---------------------------- |
| status                       | Успешность операции: true - успешнаяfalse - неуспешная                                                      | boolean     | да                         |
| transferStatus               | Статус операции перевода: см. в Списке статусов перевода и их описания                                     | String      | да                         |
| paymentId                    | Идентификаторпереводав системекешбэк-сервиса «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» | Number (43) | да                         |
| errorCode                    | Код ошибки: «0» - если успешно                                                                             | String(20)  | да                         |
| message                      | Краткое описание ошибки                                                                                    | String      | нет                       |
| orderId                      | Номер заказа в системе Продавца                                                                            | String(36)  | да                         |

---
### **Confirmation :: Метод подтверждение транзакции по смс:**

```
$api->confirmation(
        79000000000, // Телефон пользователя
        1234 // смс-код
    );
```

#### **Запрос:**

| **Наименование** | **Описание**                                                                                                                           | **Тип** | **Обязательный** |
|------------------|----------------------------------------------------------------------------------------------------------------------------------------| ---------- | ---------------------------- |
| uidPlatform      | Идентификаторплатформы. Выдается продавцукешбэк-сервисом «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» при регистрации | String(20) | да                         |
| phone            | Номер телефона клиента в формате: 79999999999                                                                                          | Number(11) | да                         |
| code             | Код из смс                                                                                                                             | Number(10) | да                         |
| token            | См. [Подпись запроса](#_Token_::_п "Подпись запроса")                                                                                                                    | string     | да                         |

#### **Ответ:**

| **Наименование** | **Описание**                                                                                                                                           | **Тип**  | **Обязательный** |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ---------------------------- |
| status                       | Успешность операции: true - успешная false - неуспешная                                                                     | boolean     | да                         |
| errorCode                    | Код ошибки: «0» - если успешно                                                                                                           | String(20)  | да                         |
| message                      | Краткое описание ошибки                                                                                                                   | String      | нет                       |
---

### **Receipt :: Метод регистрации чека пользователя:**

```
$api->receipt(
        [
            'phone' => 79000000000, // Телефон пользователя
            'discount' => 10, // Сумма скидки
            'amount'  => 10000, // Сумма покупки в копейках
            'fn'  => 123456789, // Номер фискального накопителя
            'fd'  => 123456789, // Номер фискального документа
            'fp'  => 123456789, // Фискальный признак документа
            'pay_date'  => '01.06.2023 10:00:00', // Дата и время покупки
            'receipt_type'  => 1 // Вид чека
        ]
    );
```
#### **Запрос:**

| **Наименование** | **Описание**                                                                                                                             | **Тип**    | **Обязательный** |
|------------------|------------------------------------------------------------------------------------------------------------------------------------------|------------|------------------|
| uidPlatform      | Идентификатор платформы. Выдается продавцу кешбэк-сервисом «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» при регистрации | String(20) | да               |
| phone            | Номер телефона клиента в формате: 79999999999                                                                                            | Number(11) | да               |
| amount           | Сумма операции в копейках                                                                                                                | Number(10) | да               |
| fn               | Номер фискального накопителя                                                                                                             | Number(16) | да               |
| fd               | Номер фискального документа                                                                                                              | Number(16) | да               |
| fp               | Фискальный признак документа                                                                                                             | Number(16) | да               |
| pay_date         | Дата и время покупки (формат d.m.Y H:i:s)                                                                                                | string     | да               |
| receipt_type     | Вид чека                                                                                                                                 | Number(1)  | да               |
| token            | См. [Подпись запроса](#_Token_::_п "Подпись запроса")                                                                                    | string     | да               |

#### **Ответ:**

| **Наименование** | **Описание**                                                                                                                                           | **Тип**  | **Обязательный** |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- | ---------------------------- |
| status                       | Успешность операции: true - успешная false - неуспешная                                                                     | boolean     | да                         |
| errorCode                    | Код ошибки: «0» - если успешно                                                                                                           | String(20)  | да                         |
| message                      | Краткое описание ошибки                                                                                                                   | String      | нет                       |
---
---
## Подтверждение перевода

Метод отвечает за отправку статуса подтверждения перевода баллов. Данный метод отправляется самим API-сервисом, после того, как пользователь кешбэк-сервиса «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» ввёл код подтверждения оплаты, тем самым подтвердив, что хочет перевести указанное количество баллов на счёт ТСП (Продавца).

Данные запроса отправляются POST методом на указанный адрес ***NotificationURL*** (*URL-путь до обработчика статуса ответа*).

Формат запроса / Формат ответа: JSON

#### **Возвращаемые данные:**


| **Наименование** | **Описание**                                                                                                                          | **Тип** | **Обязательный** |
| ---------------------------- |---------------------------------------------------------------------------------------------------------------------------------------| ---------- | ---------------------------- |
| status                       | Успешность операции: true - успешнаяfalse - неуспешная                                                                                 | boolean    | да                         |
| transferStatus               | Статус операции перевода: см. в Списке статусов перевода и их описания                                                                | String     | да                         |
| errorCode                    | Код ошибки: «0» - если успешно                                                                                                        | String(20) | да                         |
| message                      | Краткое описание ошибки                                                                                                               | String     | нет                       |
| uidPlatform                  | Идентификаторплатформы. Выдается продавцукешбэк-сервисом «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» при регистрации | String(20) | да                         |
| orderId                      | Номер заказа в системе Продавца                                                                                                       | String(36) | да                         |

**ВАЖНО!!!** После проверки и обновления статуса оплаты (перевода) на стороне ТСП (Продавца) API-сервис должен получить ответ «OK», в этом случае кешбэк-сервиса «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» засчитает подтверждение автоматически CONFIRMED.

## **Token** :: подпись запроса

Для каждого запроса в кешбэк-сервис «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")» необходимо вычислить хэш-подпись запроса. Для этого соберем массив всех параметров в формате пар "ключ":"значение", затем добавим в массив пару "**SecretKey** ":"значение", где **SecretKey** – секретный-ключ из личного кабинета ТСП, и отсортируем массив по ключам в алфавитном порядке.

Конкатенируем значения всех пар. Для полученной строки вычислим хэш **SHA-256**. **ВАЖНО!!!** Подпись запроса (токен) формируется индивидуально для каждого запроса на основе передаваемых в нем параметров.

## **Список статусов перевода и их описание**


| **Статус** | **Описание**                                                                                                                                                                                                                                                                                                                                              |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **NEW**          | Статус присваивается транзакции после её регистрации (создания) вкешбэк-сервисе «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")»                                                                                                                                      |
| **FORM_SHOWED**  | Статут присваивается транзакции, после того, как пользователь перешел по ссылке, отправленнойкешбэк-сервисом «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")»продавцу и открыл формудля перевода баллов |
| **REJECTED**     | Статус присваивается транзакции в случае, если не удалось осуществить перевод баллов продавцу                                                                                                                                                                                    |
| **CANCELED**     | Статусприсваивается транзакции в случае, если в отведенный срок времени «жизни» формы не было произведено ни каких действий                                                                                                                             |
| **CONFIRMED**    | Статусприсваивается транзакции в случае,когда был успешно осуществлен перевод баллов от клиента продавцу                                                                                                                                                              |

## Тестирование запросов

Для тестирования запросов необходим указать демо-настройки:

* **DevSecretKey** тестовый секретный ключ;
* **UidPlatform** uid-платформы;

Для тестирования функционала перевода баллов необходимо использовать следующие данные:


|   | **Телефон** | **Статусы и комментарии**                                         |
| - | ------------------ |-------------------------------------------------------------------|
| 1 | 79000000001        | **CONFIRMED** Успешная оплата. Баланс пользователя 1000000 баллов |
| 2 | 79000000002        | **REJECTED** Не достаточно средств. Баланс пользователя 0 баллов  |
| 3 | 79000000003        | **CANCELED** Ошибка перевода. Баланс пользователя 0 баллов        |

Остальные номера будут игнорироваться с выводом соответствующих ошибок

**ВНИМАНИЕ!!!** Данные настройки являются тестовыми, отправляемые данные не будут сохраняться в кешбэк-сервисе «[Купи-Купи](https://kupi-kupi.com/"https://kupi-kupi.com/")»
